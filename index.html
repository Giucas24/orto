function selectTerritory(territoryId) {
deselectTerritory();
gameState.selectedTerritory = territoryId;

// Evidenzia il territorio selezionato
const territory = document.getElementById(territoryId);
territory.classList.add('selected');

// Crea overlay visivo per selezione
const overlay = document.getElementById('selection-overlay');
const selectionCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
selectionCircle.setAttribute('id', 'selection-indicator');
selectionCircle.setAttribute('cx', territory.getAttribute('cx'));
selectionCircle.setAttribute('cy', territory.getAttribute
<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <title>ü•ï Orto Conquista - La Battaglia Vegetale</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #a8e6cf, #deff8b, #ffd93d);
            font-family: 'Comic Sans MS', 'Verdana', sans-serif;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        .game-header {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .game-header h1 {
            margin: 0;
            color: #2e7d32;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 2.5em;
        }

        .game-container {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .map-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
        }

        .controls-panel {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        svg {
            width: 100%;
            height: 650px;
            border-radius: 10px;
            background: linear-gradient(45deg, #e8f5e8, #f0f8e8);
            border: 3px solid #4caf50;
        }

        .territory {
            cursor: pointer;
            transition: all 0.3s ease;
            stroke: #2e7d32;
            stroke-width: 3;
        }

        .territory:hover {
            stroke: #fff700;
            stroke-width: 5;
            stroke-dasharray: 5, 5;
            animation: glow 1s infinite;
        }

        .territory.selected {
            stroke: #ff4444;
            stroke-width: 6;
            stroke-dasharray: 10, 5;
            animation: pulse 1.5s infinite;
        }

        .territory.attackable {
            stroke: #00ff00;
            stroke-width: 5;
            stroke-dasharray: 8, 8;
            animation: attackGlow 1.5s infinite;
        }

        .region-border {
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .region-border:hover {
            stroke-width: 5;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        }

        @keyframes pulse {

            0%,
            100% {
                stroke-opacity: 1;
                stroke-width: 6;
            }

            50% {
                stroke-opacity: 0.4;
                stroke-width: 8;
            }
        }

        @keyframes glow {

            0%,
            100% {
                stroke: #fff700;
            }

            50% {
                stroke: #ffff00;
            }
        }

        @keyframes attackGlow {

            0%,
            100% {
                stroke: #00ff00;
                stroke-width: 5;
                filter: drop-shadow(0 0 5px #00ff00);
            }

            50% {
                stroke: #44ff44;
                stroke-width: 7;
                filter: drop-shadow(0 0 15px #00ff00);
            }
        }

        .unit-count {
            font-size: 18px;
            font-weight: bold;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
            stroke: #333;
            stroke-width: 2;
            paint-order: stroke;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.7));
        }

        .label {
            font-size: 11px;
            pointer-events: none;
            fill: #2e7d32;
            text-anchor: middle;
            font-weight: bold;
            filter: drop-shadow(1px 1px 2px rgba(255, 255, 255, 0.8));
        }

        .current-player {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            border: 3px solid #f57f17;
        }

        .faction-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 6px solid;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            font-size: 14px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .button:disabled {
            background: linear-gradient(45deg, #bdbdbd, #9e9e9e);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .button.attack {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .button.attack:hover {
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }

        .button.special {
            background: linear-gradient(45deg, #9c27b0, #7b1fa2);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
        }

        .button.special:hover {
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4);
        }

        .phase-indicator {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            border: 3px solid #2196f3;
            font-size: 16px;
            font-weight: bold;
        }

        .battle-log {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 15px;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 3px solid #ff9800;
        }

        .log-entry {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
            border-left: 4px solid;
        }

        .log-attack {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .log-defend {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .log-move {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .log-special {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }

        .cards-section {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 3px solid #e91e63;
        }

        .event-card {
            background: linear-gradient(45deg, #ffecb3, #fff176);
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
            border: 2px solid #ffc107;
            cursor: pointer;
            transition: all 0.3s;
        }

        .event-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
        }

        .stats-panel {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c8);
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #4caf50;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-weight: bold;
        }

        /* Colori delle fazioni */
        .cavolfiori {
            fill: #e8d5e8;
        }

        .cipolle {
            fill: #d1a3d1;
        }

        .carote {
            fill: #ffb347;
        }

        .broccoli {
            fill: #90ee90;
        }

        .pomodori {
            fill: #ff7f7f;
        }

        .neutrale {
            fill: #f0e68c;
        }

        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .victory-content {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 5px solid #f57f17;
        }

        .dice-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 10px 0;
        }

        .dice {
            width: 30px;
            height: 30px;
            background: white;
            border: 2px solid #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .dice.attacker {
            border-color: #f44336;
        }

        .dice.defender {
            border-color: #4caf50;
        }
    </style>
</head>

<body>
    <div class="game-header">
        <h1>ü•ï ORTO CONQUISTA ü•ï</h1>
        <p>La battaglia vegetale pi√π epica del giardino!</p>
    </div>

    <div class="game-container">
        <div class="map-container">
            <svg viewBox="0 0 800 600" id="game-map">
                <!-- Sfondo dell'orto -->
                <defs>
                    <pattern id="grass" patternUnits="userSpaceOnUse" width="20" height="20">
                        <rect width="20" height="20" fill="#7cb342" />
                        <circle cx="5" cy="5" r="1" fill="#8bc34a" />
                        <circle cx="15" cy="15" r="1" fill="#9ccc65" />
                        <circle cx="10" cy="18" r="1" fill="#689f38" />
                    </pattern>

                    <!-- Texture per le regioni -->
                    <pattern id="cipolleTex" patternUnits="userSpaceOnUse" width="15" height="15">
                        <rect width="15" height="15" fill="#d1a3d1" />
                        <circle cx="7" cy="7" r="2" fill="#c9a0dc" opacity="0.7" />
                    </pattern>

                    <pattern id="caroteTex" patternUnits="userSpaceOnUse" width="15" height="15">
                        <rect width="15" height="15" fill="#ffb347" />
                        <path d="M2,2 L8,8 L2,14 Z" fill="#ffa500" opacity="0.6" />
                    </pattern>

                    <pattern id="pomodoriTex" patternUnits="userSpaceOnUse" width="15" height="15">
                        <rect width="15" height="15" fill="#ff7f7f" />
                        <circle cx="7" cy="7" r="3" fill="#ff6347" opacity="0.8" />
                    </pattern>

                    <pattern id="broccoliTex" patternUnits="userSpaceOnUse" width="15" height="15">
                        <rect width="15" height="15" fill="#90ee90" />
                        <path d="M5,5 Q7,2 9,5 Q7,8 5,5" fill="#228b22" opacity="0.7" />
                    </pattern>

                    <pattern id="cavolfioriTex" patternUnits="userSpaceOnUse" width="15" height="15">
                        <rect width="15" height="15" fill="#e8d5e8" />
                        <circle cx="7" cy="7" r="2" fill="#ddd" opacity="0.8" />
                    </pattern>
                </defs>

                <!-- Sfondo dell'orto -->
                <rect width="800" height="600" fill="url(#grass)" />

                <!-- CIPOLLANDIA (Nord-Ovest) -->
                <path class="region-border"
                    d="M20,50 Q50,30 120,40 Q180,35 220,60 Q240,90 230,130 Q220,170 180,180 Q120,185 80,170 Q30,150 20,120 Q15,80 20,50 Z"
                    fill="url(#cipolleTex)" stroke="#8e24aa" stroke-width="3" opacity="0.8" />

                <!-- Disegno cipolle nella regione -->
                <g transform="translate(50,70)">
                    <ellipse cx="20" cy="15" rx="12" ry="18" fill="#9c27b0" />
                    <ellipse cx="20" cy="12" rx="8" ry="12" fill="#ba68c8" />
                    <path d="M15,5 Q20,0 25,5" stroke="#4a148c" stroke-width="2" fill="none" />
                </g>
                <g transform="translate(150,90)">
                    <ellipse cx="0" cy="0" rx="10" ry="15" fill="#8e24aa" />
                    <path d="M-5,-8 Q0,-12 5,-8" stroke="#4a148c" stroke-width="2" fill="none" />
                </g>

                <text x="120" y="30" text-anchor="middle" fill="#4a148c" font-size="16"
                    font-weight="bold">CIPOLLANDIA</text>

                <!-- CAROTEGNA (Nord-Est) -->
                <path class="region-border"
                    d="M280,40 Q320,25 380,30 Q450,35 500,55 Q520,80 515,120 Q510,160 480,175 Q420,185 380,180 Q320,175 290,150 Q270,120 275,80 Q275,60 280,40 Z"
                    fill="url(#caroteTex)" stroke="#f57c00" stroke-width="3" opacity="0.8" />

                <!-- Disegno carote nella regione -->
                <g transform="translate(350,70)">
                    <polygon points="0,20 -8,0 8,0" fill="#ff6f00" />
                    <polygon points="0,15 -6,0 6,0" fill="#ff8f00" />
                    <path d="M-2,-2 L-2,-8 M0,-2 L0,-10 M2,-2 L2,-8" stroke="#388e3c" stroke-width="2" />
                </g>
                <g transform="translate(420,100)">
                    <polygon points="0,15 -6,0 6,0" fill="#ef6c00" />
                    <path d="M-1,-2 L-1,-6 M1,-2 L1,-6" stroke="#2e7d32" stroke-width="1" />
                </g>

                <text x="390" y="25" text-anchor="middle" fill="#e65100" font-size="16"
                    font-weight="bold">CAROTEGNA</text>

                <!-- SAN MARZANO (Sud-Ovest) -->
                <path class="region-border"
                    d="M20,350 Q40,330 100,335 Q160,340 200,360 Q230,390 220,430 Q210,470 180,490 Q120,510 80,500 Q40,485 25,450 Q15,410 20,380 Q18,365 20,350 Z"
                    fill="url(#pomodoriTex)" stroke="#d32f2f" stroke-width="3" opacity="0.8" />

                <!-- Disegno pomodori nella regione -->
                <g transform="translate(80,400)">
                    <circle cx="0" cy="0" r="12" fill="#f44336" />
                    <circle cx="0" cy="-2" r="8" fill="#ff5722" />
                    <path d="M-8,-8 Q-5,-12 0,-10 Q5,-12 8,-8" fill="#4caf50" stroke="#2e7d32" stroke-width="1" />
                </g>
                <g transform="translate(150,440)">
                    <circle cx="0" cy="0" r="8" fill="#e53935" />
                    <path d="M-5,-6 Q0,-8 5,-6" fill="#388e3c" />
                </g>

                <text x="120" y="325" text-anchor="middle" fill="#b71c1c" font-size="16" font-weight="bold">SAN
                    MARZANO</text>

                <!-- BROCCOLANDIA (Sud-Est) -->
                <path class="region-border"
                    d="M300,350 Q340,335 400,340 Q460,345 500,365 Q530,395 520,435 Q510,475 480,495 Q420,515 380,510 Q340,505 315,480 Q290,450 295,410 Q298,380 300,350 Z"
                    fill="url(#broccoliTex)" stroke="#388e3c" stroke-width="3" opacity="0.8" />

                <!-- Disegno broccoli nella regione -->
                <g transform="translate(380,420)">
                    <ellipse cx="0" cy="5" rx="3" ry="15" fill="#2e7d32" />
                    <circle cx="-8" cy="-5" r="6" fill="#4caf50" />
                    <circle cx="0" cy="-8" r="7" fill="#43a047" />
                    <circle cx="8" cy="-5" r="6" fill="#66bb6a" />
                    <circle cx="0" cy="-2" r="5" fill="#388e3c" />
                </g>
                <g transform="translate(450,460)" scale="0.7">
                    <ellipse cx="0" cy="3" rx="2" ry="10" fill="#1b5e20" />
                    <circle cx="-5" cy="-3" r="4" fill="#4caf50" />
                    <circle cx="5" cy="-3" r="4" fill="#66bb6a" />
                    <circle cx="0" cy="-5" r="5" fill="#43a047" />
                </g>

                <text x="410" y="325" text-anchor="middle" fill="#1b5e20" font-size="16"
                    font-weight="bold">BROCCOLANDIA</text>

                <!-- REGNO DEI CAVOLFIORI (Est) -->
                <path class="region-border"
                    d="M550,50 Q590,35 650,40 Q710,45 740,70 Q760,100 755,140 Q750,180 720,200 Q660,220 620,215 Q580,210 560,185 Q540,155 545,115 Q548,85 550,50 Z"
                    fill="url(#cavolfioriTex)" stroke="#7b1fa2" stroke-width="3" opacity="0.8" />

                <!-- Disegno cavolfiori nella regione -->
                <g transform="translate(630,110)">
                    <circle cx="0" cy="5" r="15" fill="#f5f5f5" />
                    <circle cx="-8" cy="-2" r="8" fill="#eeeeee" />
                    <circle cx="8" cy="-2" r="8" fill="#e0e0e0" />
                    <circle cx="0" cy="-8" r="10" fill="#f8f8f8" />
                    <ellipse cx="0" cy="18" rx="4" ry="8" fill="#2e7d32" />
                </g>

                <text x="650" y="30" text-anchor="middle" fill="#4a148c" font-size="14" font-weight="bold">REGNO DEI
                    CAVOLFIORI</text>

                <!-- MERCATO CENTRALE -->
                <path class="region-border"
                    d="M240,220 Q280,200 350,205 Q420,210 460,235 Q480,265 475,295 Q470,325 440,340 Q370,355 330,350 Q280,345 250,320 Q220,290 225,255 Q230,235 240,220 Z"
                    fill="#f0e68c" stroke="#f57f17" stroke-width="4" opacity="0.9" />

                <!-- Edifici del Mercato Centrale -->
                <!-- Grand Bazaar - Tenda mercato -->
                <g transform="translate(280,260)">
                    <polygon points="-15,15 0,-10 15,15" fill="#d84315" />
                    <rect x="-12" y="15" width="24" height="10" fill="#8d6e63" />
                    <rect x="-8" y="18" width="4" height="7" fill="#5d4037" />
                    <rect x="4" y="18" width="4" height="7" fill="#5d4037" />
                </g>

                <!-- Seed Bank - Magazzino -->
                <g transform="translate(380,240)">
                    <rect x="-15" y="5" width="30" height="20" fill="#795548" />
                    <polygon points="-15,5 0,-5 15,5" fill="#5d4037" />
                    <circle cx="0" cy="15" r="3" fill="#ffeb3b" />
                </g>

                <!-- Compost Works - Cumulo -->
                <g transform="translate(340,300)">
                    <ellipse cx="0" cy="10" rx="20" ry="8" fill="#6d4c41" />
                    <ellipse cx="-5" cy="5" rx="12" ry="6" fill="#8d6e63" />
                    <ellipse cx="8" cy="7" rx="10" ry="5" fill="#5d4037" />
                </g>

                <!-- Greenhouse Labs - Serra -->
                <g transform="translate(420,280)">
                    <rect x="-12" y="8" width="24" height="15" fill="#c8e6c9" />
                    <polygon points="-12,8 0,-2 12,8" fill="#a5d6a7" />
                    <rect x="-8" y="12" width="3" height="8" fill="#4caf50" />
                    <rect x="5" y="12" width="3" height="8" fill="#66bb6a" />
                </g>

                <text x="360" y="195" text-anchor="middle" fill="#e65100" font-size="16" font-weight="bold">MERCATO
                    CENTRALE</text>

                <!-- Territori cliccabili (invisibili ma funzionali) -->
                <!-- Cipollandia -->
                <circle class="territory cipolle" id="bulbopoli" cx="90" cy="100" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory cipolle" id="tropea" cx="160" cy="80" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory cipolle" id="scalogna" cx="130" cy="140" r="25" fill="transparent"
                    stroke="transparent" />

                <!-- Carotegna -->
                <circle class="territory carote" id="carrot" cx="350" cy="100" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory carote" id="orange" cx="420" cy="80" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory carote" id="root" cx="380" cy="140" r="25" fill="transparent"
                    stroke="transparent" />

                <!-- San Marzano -->
                <circle class="territory pomodori" id="sanmarzano" cx="100" cy="400" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory pomodori" id="cherry" cx="150" cy="460" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory pomodori" id="pachino" cx="180" cy="400" r="25" fill="transparent"
                    stroke="transparent" />

                <!-- Broccolandia -->
                <circle class="territory broccoli" id="greenvalley" cx="360" cy="420" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory broccoli" id="forest" cx="430" cy="460" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory broccoli" id="cavolonero" cx="460" cy="400" r="25" fill="transparent"
                    stroke="transparent" />

                <!-- Regno Cavolfiori -->
                <circle class="territory cavolfiori" id="snowpeak" cx="600" cy="100" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory cavolfiori" id="frostland" cx="670" cy="80" r="25" fill="transparent"
                    stroke="transparent" />
                <circle class="territory cavolfiori" id="iceberg" cx="640" cy="140" r="25" fill="transparent"
                    stroke="transparent" />

                <!-- Mercato Centrale -->
                <circle class="territory neutrale" id="bazaar" cx="280" cy="260" r="20" fill="transparent"
                    stroke="transparent" />
                <circle class="territory neutrale" id="seedbank" cx="380" cy="240" r="20" fill="transparent"
                    stroke="transparent" />
                <circle class="territory neutrale" id="compost" cx="340" cy="300" r="20" fill="transparent"
                    stroke="transparent" />
                <circle class="territory neutrale" id="greenhouse" cx="420" cy="280" r="20" fill="transparent"
                    stroke="transparent" />

                <!-- Connessioni visibili -->
                <g id="connections" opacity="0.4"></g>

                <!-- Overlay per selezione territori -->
                <g id="selection-overlay"></g>

                <!-- Unit counts -->
                <g id="unit-counts"></g>

                <!-- Labels dei territori -->
                <text class="label" x="90" y="125" font-size="10">Bulbopoli</text>
                <text class="label" x="160" y="105" font-size="10">Tropea</text>
                <text class="label" x="130" y="165" font-size="10">Scalogna</text>

                <text class="label" x="350" y="125" font-size="10">Carrot City</text>
                <text class="label" x="420" y="105" font-size="10">Orange County</text>
                <text class="label" x="380" y="165" font-size="10">Root Deep</text>

                <text class="label" x="100" y="425" font-size="10">San Marzano</text>
                <text class="label" x="150" y="485" font-size="10">Cherry Valley</text>
                <text class="label" x="180" y="425" font-size="10">Pachino</text>

                <text class="label" x="360" y="445" font-size="10">Green Valley</text>
                <text class="label" x="430" y="485" font-size="10">Forest</text>
                <text class="label" x="460" y="425" font-size="10">Cavolo Nero</text>

                <text class="label" x="600" y="125" font-size="10">Snow Peak</text>
                <text class="label" x="670" y="105" font-size="10">Frost Land</text>
                <text class="label" x="640" y="165" font-size="10">Iceberg</text>

                <text class="label" x="280" y="285" font-size="9">Bazaar</text>
                <text class="label" x="380" y="265" font-size="9">Seed Bank</text>
                <text class="label" x="340" y="325" font-size="9">Compost</text>
                <text class="label" x="420" y="305" font-size="9">Greenhouse</text>
            </svg>
        </div>

        <div class="controls-panel">
            <div class="current-player" id="current-player">
                <h3>üéØ Turno di: <span id="player-name">Cavolfiori</span></h3>
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div id="player-color"
                        style="width: 25px; height: 25px; border-radius: 50%; border: 3px solid #333;"></div>
                    <span id="player-emoji" style="font-size: 24px;">‚ùÑÔ∏è</span>
                </div>
                <div>Turno: <span id="turn-counter">1</span></div>
            </div>

            <div class="phase-indicator" id="phase-indicator">
                <strong>üéÆ Fase: <span id="current-phase">Rinforzi</span></strong>
                <div id="phase-timer" style="margin-top: 5px; font-size: 12px;">‚è∞ Tempo illimitato</div>
            </div>

            <div class="faction-info" id="faction-info">
                <h4 id="faction-name">‚ùÑÔ∏è Clan dei Cavolfiori</h4>
                <p><strong>üëë Leader:</strong> <span id="leader-name">Generale Cavolo Brassius</span></p>
                <p><strong>üîÆ Abilit√†:</strong> <span id="ability-name">Resistenza Glaciale</span></p>
                <p><small id="ability-desc">Una volta per turno pu√≤ rigenerare 1 unit√†</small></p>
                <p><strong>üí™ Bonus:</strong> <span id="faction-bonus">+1 difesa in montagna</span></p>
                <p><strong>‚ö†Ô∏è Debolezza:</strong> <span id="faction-weakness">-1 vs Carote</span></p>

                <div class="stat-item">
                    <span>üè∞ Territori:</span>
                    <span id="territory-count">3</span>
                </div>
                <div class="stat-item">
                    <span>üéñÔ∏è Rinforzi:</span>
                    <span id="reinforcements">4</span>
                </div>

                <button class="button special" id="leader-ability" onclick="useLeaderAbility()">
                    üåü Usa Abilit√† Leader
                </button>
            </div>

            <div class="controls">
                <button class="button" id="place-reinforcements" onclick="placeReinforcements()">
                    ‚ö° Piazza Rinforzi Auto
                </button>
                <button class="button" id="next-phase" onclick="nextPhase()">
                    ‚û°Ô∏è Prossima Fase
                </button>
                <button class="button attack" id="attack-btn" onclick="toggleAttackMode()" disabled>
                    ‚öîÔ∏è Modalit√† Attacco
                </button>
                <button class="button" id="end-turn" onclick="endTurn()" disabled>
                    üîÑ Fine Turno
                </button>
            </div>

            <div class="cards-section" id="cards-section">
                <h4>üé¥ Carte Evento</h4>
                <div id="event-cards">
                    <div class="event-card" onclick="drawEventCard()">
                        üé≤ Pesca Carta Evento
                    </div>
                </div>
            </div>

            <div class="battle-log">
                <h4>üìú Log delle Battaglie</h4>
                <div id="log-content">
                    <div class="log-entry log-move">üéÆ Orto Conquista iniziato! I Cavolfiori preparano la loro strategia
                        glaciale...</div>
                </div>
            </div>

            <div class="stats-panel">
                <h4>üìä Statistiche</h4>
                <div class="stat-item">
                    <span>üåç Territori Totali:</span>
                    <span>16</span>
                </div>
                <div class="stat-item">
                    <span>‚öîÔ∏è Battaglie:</span>
                    <span id="battle-count">0</span>
                </div>
                <div class="stat-item">
                    <span>üéØ Obiettivo:</span>
                    <span>Conquista Totale</span>
                </div>
            </div>
        </div>
    </div>

    <div class="victory-screen" id="victory-screen">
        <div class="victory-content">
            <h2 id="victory-title">üèÜ VITTORIA! üèÜ</h2>
            <p id="victory-message">I Cavolfiori hanno conquistato l'orto!</p>
            <button class="button" onclick="resetGame()">üîÑ Nuova Partita</button>
        </div>
    </div>

    <script>
        // Stato del gioco
        let gameState = {
            currentPlayer: 0,
            phase: 'reinforcement',
            selectedTerritory: null,
            attackMode: false,
            reinforcements: 4,
            turn: 1,
            battleCount: 0,
            players: [
                {
                    name: 'Cavolfiori',
                    emoji: '‚ùÑÔ∏è',
                    color: '#e8d5e8',
                    territories: ['snowpeak', 'frostland', 'iceberg'],
                    leader: 'Generale Cavolo Brassius',
                    ability: 'Resistenza Glaciale',
                    abilityDescription: 'Una volta per turno pu√≤ rigenerare 1 unit√† in un territorio che ha subito perdite',
                    bonus: '+1 difesa in territori di montagna',
                    weakness: '-1 attacco contro fazioni di radice (Carote)',
                    abilityUsed: false,
                    cards: []
                },
                {
                    name: 'Cipolle',
                    emoji: 'üßÖ',
                    color: '#d1a3d1',
                    territories: ['bulbopoli', 'tropea', 'scalogna'],
                    leader: 'Duca Cipollotto di Tropea',
                    ability: 'Lacrime Corrosive',
                    abilityDescription: 'In battaglia, il nemico perde automaticamente 1 dado',
                    bonus: '+1 attacco contro tutte le fazioni non-bulbo',
                    weakness: 'Perde 1 unit√† extra con eventi acqua',
                    abilityUsed: false,
                    cards: []
                },
                {
                    name: 'Carote',
                    emoji: 'ü•ï',
                    color: '#ffb347',
                    territories: ['carrot', 'orange', 'root'],
                    leader: 'Imperatrice Carota Regina',
                    ability: 'Vista Acuta',
                    abilityDescription: 'Pu√≤ vedere le info degli avversari adiacenti',
                    bonus: '+1 rinforzo ogni 3 territori controllati',
                    weakness: '-1 difesa contro fazioni aeree (Broccoli, Cavolfiori)',
                    abilityUsed: false,
                    cards: []
                },
                {
                    name: 'Broccoli',
                    emoji: 'ü•¶',
                    color: '#90ee90',
                    territories: ['greenvalley', 'forest', 'cavolonero'],
                    leader: 'Sciamano Broccolo Antico',
                    ability: 'Germogli Selvaggi',
                    abilityDescription: 'Pu√≤ evocare 1 unit√† bonus in qualsiasi territorio controllato',
                    bonus: '+2 rinforzi in territori fertili',
                    weakness: 'Perde 1 unit√† extra con carte pesticidi',
                    abilityUsed: false,
                    cards: []
                },
                {
                    name: 'Pomodori',
                    emoji: 'üçÖ',
                    color: '#ff7f7f',
                    territories: ['sanmarzano', 'cherry', 'pachino'],
                    leader: 'Generale Pomodoro San Marzano',
                    ability: 'Polpa Esplosiva',
                    abilityDescription: 'Quando attacca, infligge 1 danno al territorio nemico adiacente',
                    bonus: '+1 attacco quando ha 5+ unit√† in un territorio',
                    weakness: '-1 difesa in territori secchi o montani',
                    abilityUsed: false,
                    cards: []
                }
            ],
            territories: {},
            eventCards: [
                { name: 'Grandinata Devastante', effect: 'destroy', power: 2, description: 'Distrugge 2 unit√† in una regione' },
                { name: 'Miracolo Agricolo', effect: 'boost', power: 5, description: '+5 rinforzi immediati' },
                { name: 'Invasione Afidi', effect: 'halve', power: 1, description: 'Il nemico perde met√† unit√†' },
                { name: 'Attacco Lampo', effect: 'extra_attacks', power: 3, description: '+3 attacchi extra' },
                { name: 'Super Fertilizzante', effect: 'grow_all', power: 2, description: '+2 unit√† ovunque' }
            ]
        };

        // Tipi di territorio e loro caratteristiche
        const territoryTypes = {
            // Territori di montagna (bonus Cavolfiori)
            'snowpeak': { type: 'mountain', name: 'Snow Peak', region: 'cavolfiori' },
            'frostland': { type: 'mountain', name: 'Frost Land', region: 'cavolfiori' },
            'iceberg': { type: 'mountain', name: 'Iceberg', region: 'cavolfiori' },
            'bulbopoli': { type: 'humid', name: 'Bulbopoli', region: 'cipollandia' },

            // Territori fertili (bonus Broccoli)
            'greenvalley': { type: 'fertile', name: 'Green Valley', region: 'broccolandia' },
            'forest': { type: 'fertile', name: 'Broccoli Forest', region: 'broccolandia' },
            'compost': { type: 'fertile', name: 'Compost Works', region: 'mercato' },

            // Territori secchi (debolezza Pomodori)
            'orange': { type: 'dry', name: 'Orange County', region: 'carotegna' },
            'root': { type: 'dry', name: 'Root Deep', region: 'carotegna' },

            // Altri territori
            'tropea': { type: 'humid', name: 'Tropea Fields', region: 'cipollandia' },
            'scalogna': { type: 'normal', name: 'Scalogna Valley', region: 'cipollandia' },
            'carrot': { type: 'normal', name: 'Carrot City', region: 'carotegna' },
            'sanmarzano': { type: 'hot', name: 'San Marzano', region: 'tomatosia' },
            'cherry': { type: 'hot', name: 'Cherry Valley', region: 'tomatosia' },
            'pachino': { type: 'hot', name: 'Pachino Coast', region: 'tomatosia' },
            'cavolonero': { type: 'fertile', name: 'Cavolo Nero', region: 'broccolandia' },
            'bazaar': { type: 'market', name: 'Grand Bazaar', region: 'mercato' },
            'seedbank': { type: 'market', name: 'Seed Bank', region: 'mercato' },
            'greenhouse': { type: 'market', name: 'Greenhouse Labs', region: 'mercato' }
        };

        // Adiacenze tra territori
        const adjacencies = {
            'bulbopoli': ['tropea', 'scalogna', 'bazaar'],
            'tropea': ['bulbopoli', 'scalogna', 'carrot', 'bazaar'],
            'scalogna': ['bulbopoli', 'tropea', 'bazaar', 'compost'],
            'carrot': ['tropea', 'orange', 'root', 'seedbank'],
            'orange': ['carrot', 'root', 'seedbank', 'greenhouse'],
            'root': ['carrot', 'orange', 'seedbank', 'compost'],
            'sanmarzano': ['cherry', 'pachino', 'bazaar', 'compost'],
            'cherry': ['sanmarzano', 'pachino', 'compost', 'greenvalley'],
            'pachino': ['sanmarzano', 'cherry', 'compost', 'greenvalley'],
            'greenvalley': ['cherry', 'pachino', 'forest', 'cavolonero', 'compost', 'greenhouse'],
            'forest': ['greenvalley', 'cavolonero', 'greenhouse'],
            'cavolonero': ['greenvalley', 'forest', 'greenhouse'],
            'snowpeak': ['frostland', 'iceberg', 'seedbank'],
            'frostland': ['snowpeak', 'iceberg', 'orange', 'greenhouse'],
            'iceberg': ['snowpeak', 'frostland', 'greenhouse'],
            'bazaar': ['bulbopoli', 'tropea', 'scalogna', 'sanmarzano', 'seedbank', 'compost'],
            'seedbank': ['carrot', 'orange', 'root', 'snowpeak', 'bazaar', 'compost', 'greenhouse'],
            'compost': ['scalogna', 'root', 'sanmarzano', 'cherry', 'pachino', 'greenvalley', 'bazaar', 'seedbank', 'greenhouse'],
            'greenhouse': ['orange', 'frostland', 'iceberg', 'greenvalley', 'forest', 'cavolonero', 'seedbank', 'compost']
        };

        // Relazioni tra fazioni
        const factionRelations = {
            0: { weakness: [2], aerial: true }, // Cavolfiori vs Carote
            1: { bonus: [0, 2, 3, 4], bulb: true }, // Cipolle vs tutti tranne se stessi
            2: { weakness: [0, 3], root: true }, // Carote vs aeree
            3: { aerial: true }, // Broccoli
            4: { weakness: [] } // Pomodori (territorio-dipendente)
        };

        // Inizializzazione del gioco
        function initGame() {
            // Inizializza territori con unit√†
            gameState.players.forEach((player, playerIndex) => {
                player.territories.forEach(territoryId => {
                    gameState.territories[territoryId] = {
                        owner: playerIndex,
                        units: Math.floor(Math.random() * 3) + 2
                    };
                });
            });

            // Territori neutrali del mercato centrale
            ['bazaar', 'seedbank', 'compost', 'greenhouse'].forEach(territoryId => {
                gameState.territories[territoryId] = {
                    owner: -1, // neutrale
                    units: 1
                };
            });

            drawConnections();
            updateDisplay();
            addEventListeners();
            addLogEntry('üéÆ Benvenuti all\'Orto Conquista! Che la battaglia vegetale abbia inizio!', 'log-special');
        }

        // Disegna le connessioni tra territori
        function drawConnections() {
            const connectionsGroup = document.getElementById('connections');
            connectionsGroup.innerHTML = '';

            Object.entries(adjacencies).forEach(([territoryId, connections]) => {
                const territory1 = document.getElementById(territoryId);
                if (!territory1) return;

                connections.forEach(connectedId => {
                    const territory2 = document.getElementById(connectedId);
                    if (!territory2) return;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', territory1.getAttribute('cx'));
                    line.setAttribute('y1', territory1.getAttribute('cy'));
                    line.setAttribute('x2', territory2.getAttribute('cx'));
                    line.setAttribute('y2', territory2.getAttribute('cy'));
                    line.setAttribute('stroke', '#666');
                    line.setAttribute('stroke-width', '2');
                    connectionsGroup.appendChild(line);
                });
            });
        }

        // Calcola rinforzi
        function calculateReinforcements(playerIndex) {
            const player = gameState.players[playerIndex];
            let reinforcements = Math.max(3, Math.floor(player.territories.length / 2));

            // Bonus Carote: +1 rinforzo ogni 3 territori
            if (playerIndex === 2) {
                reinforcements += Math.floor(player.territories.length / 3);
            }

            // Bonus Broccoli: +2 rinforzi per territori fertili
            if (playerIndex === 3) {
                const fertileTerritories = player.territories.filter(tId =>
                    territoryTypes[tId] && territoryTypes[tId].type === 'fertile'
                ).length;
                reinforcements += fertileTerritories * 2;
            }

            // Bonus regioni complete
            reinforcements += calculateRegionBonuses(playerIndex);

            return reinforcements;
        }

        // Calcola bonus regioni
        function calculateRegionBonuses(playerIndex) {
            const player = gameState.players[playerIndex];
            const regions = {};

            player.territories.forEach(tId => {
                const territory = territoryTypes[tId];
                if (territory && territory.region) {
                    if (!regions[territory.region]) regions[territory.region] = 0;
                    regions[territory.region]++;
                }
            });

            let bonus = 0;
            if (regions.cipollandia === 3) bonus += 3;
            if (regions.carotegna === 3) bonus += 4;
            if (regions.tomatosia === 3) bonus += 3;
            if (regions.broccolandia === 3) bonus += 3;
            if (regions.cavolfiori === 3) bonus += 3;
            if (regions.mercato === 4) bonus += 5;

            return bonus;
        }

        // Usa abilit√† leader
        function useLeaderAbility() {
            const currentPlayer = gameState.players[gameState.currentPlayer];

            if (currentPlayer.abilityUsed) {
                addLogEntry('‚ùå Abilit√† gi√† usata questo turno!', 'log-attack');
                return;
            }

            switch (gameState.currentPlayer) {
                case 0: // Cavolfiori - Resistenza Glaciale
                    useResistenzaGlaciale();
                    break;
                case 1: // Cipolle - Lacrime Corrosive
                    useLacrimeCorrosive();
                    break;
                case 2: // Carote - Vista Acuta
                    useVistaAcuta();
                    break;
                case 3: // Broccoli - Germogli Selvaggi
                    useGermogliSelvaggi();
                    break;
                case 4: // Pomodori - Polpa Esplosiva
                    usePolpaEsplosiva();
                    break;
            }

            currentPlayer.abilityUsed = true;
            updateDisplay();
        }

        // Abilit√† specifiche
        function useResistenzaGlaciale() {
            const player = gameState.players[gameState.currentPlayer];
            const damagedTerritories = player.territories.filter(tId => {
                const territory = gameState.territories[tId];
                return territory && territory.units < 3;
            });

            if (damagedTerritories.length > 0) {
                const randomTerritory = damagedTerritories[Math.floor(Math.random() * damagedTerritories.length)];
                gameState.territories[randomTerritory].units++;
                addLogEntry(`‚ùÑÔ∏è Resistenza Glaciale: +1 unit√† rigenerata in ${territoryTypes[randomTerritory].name}!`, 'log-special');
            } else {
                addLogEntry('‚ùÑÔ∏è Resistenza Glaciale: Nessun territorio da rigenerare', 'log-special');
            }
        }

        function useLacrimeCorrosive() {
            addLogEntry('üßÖ Lacrime Corrosive attive: il prossimo attacco avr√† bonus speciale!', 'log-special');
        }

        function useVistaAcuta() {
            const adjacentPlayers = new Set();
            const currentPlayerTerritories = gameState.players[gameState.currentPlayer].territories;

            currentPlayerTerritories.forEach(tId => {
                adjacencies[tId].forEach(adjId => {
                    const adjTerritory = gameState.territories[adjId];
                    if (adjTerritory && adjTerritory.owner !== gameState.currentPlayer && adjTerritory.owner !== -1) {
                        adjacentPlayers.add(adjTerritory.owner);
                    }
                });
            });

            let infoText = 'ü•ï Vista Acuta rivela:';
            adjacentPlayers.forEach(playerIndex => {
                const player = gameState.players[playerIndex];
                infoText += ` ${player.emoji} ${player.name}: ${player.territories.length} territori;`;
            });

            addLogEntry(infoText, 'log-special');
        }

        function useGermogliSelvaggi() {
            const player = gameState.players[gameState.currentPlayer];
            if (player.territories.length > 0) {
                const randomTerritory = player.territories[Math.floor(Math.random() * player.territories.length)];
                gameState.territories[randomTerritory].units++;
                addLogEntry(`ü•¶ Germogli Selvaggi: +1 unit√† evocata in ${territoryTypes[randomTerritory].name}!`, 'log-special');
            }
        }

        function usePolpaEsplosiva() {
            addLogEntry('üçÖ Polpa Esplosiva attiva: il prossimo attacco far√† danni collaterali!', 'log-special');
        }

        // Gestisce il click sui territori
        function addEventListeners() {
            document.querySelectorAll('.territory').forEach(territory => {
                territory.addEventListener('click', handleTerritoryClick);
            });
        }

        function handleTerritoryClick(event) {
            const territoryId = event.target.id;
            const territory = gameState.territories[territoryId];

            if (gameState.phase === 'reinforcement') {
                if (territory && territory.owner === gameState.currentPlayer && gameState.reinforcements > 0) {
                    territory.units++;
                    gameState.reinforcements--;
                    addLogEntry(`‚ûï +1 unit√† piazzata in ${territoryTypes[territoryId].name}`, 'log-move');
                    updateDisplay();
                }
            } else if (gameState.phase === 'attack') {
                if (!gameState.selectedTerritory) {
                    if (territory && territory.owner === gameState.currentPlayer && territory.units > 1) {
                        selectTerritory(territoryId);
                    }
                } else if (gameState.selectedTerritory === territoryId) {
                    deselectTerritory();
                } else {
                    if (territory && territory.owner !== gameState.currentPlayer &&
                        adjacencies[gameState.selectedTerritory].includes(territoryId)) {
                        performBattle(gameState.selectedTerritory, territoryId);
                    }
                }
            }
        }

        function selectTerritory(territoryId) {
            deselectTerritory();
            gameState.selectedTerritory = territoryId;

            // Evidenzia il territorio selezionato
            const territory = document.getElementById(territoryId);
            territory.classList.add('selected');

            // Crea overlay visivo per selezione
            const overlay = document.getElementById('selection-overlay');
            const selectionCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            selectionCircle.setAttribute('id', 'selection-indicator');
            selectionCircle.setAttribute('cx', territory.getAttribute('cx'));
            selectionCircle.setAttribute('cy', territory.getAttribute('cy'));
            selectionCircle.setAttribute('r', '30');
            selectionCircle.setAttribute('fill', 'none');
            selectionCircle.setAttribute('stroke', '#ff4444');
            selectionCircle.setAttribute('stroke-width', '4');
            selectionCircle.setAttribute('stroke-dasharray', '10,5');
            selectionCircle.style.animation = 'pulse 1.5s infinite';
            overlay.appendChild(selectionCircle);

            // Evidenzia territori attaccabili
            adjacencies[territoryId].forEach(adjId => {
                const adjTerritory = gameState.territories[adjId];
                if (adjTerritory && adjTerritory.owner !== gameState.currentPlayer) {
                    const adjElement = document.getElementById(adjId);
                    adjElement.classList.add('attackable');

                    // Crea overlay per territori attaccabili
                    const attackCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    attackCircle.setAttribute('class', 'attack-indicator');
                    attackCircle.setAttribute('cx', adjElement.getAttribute('cx'));
                    attackCircle.setAttribute('cy', adjElement.getAttribute('cy'));
                    attackCircle.setAttribute('r', '28');
                    attackCircle.setAttribute('fill', 'none');
                    attackCircle.setAttribute('stroke', '#00ff00');
                    attackCircle.setAttribute('stroke-width', '3');
                    attackCircle.setAttribute('stroke-dasharray', '8,8');
                    attackCircle.style.animation = 'attackGlow 1.5s infinite';
                    overlay.appendChild(attackCircle);
                }
            });
        }

        function deselectTerritory() {
            if (gameState.selectedTerritory) {
                document.getElementById(gameState.selectedTerritory).classList.remove('selected');
                gameState.selectedTerritory = null;
            }

            // Rimuovi tutti gli overlay
            const overlay = document.getElementById('selection-overlay');
            overlay.innerHTML = '';

            // Rimuovi classi attackable
            document.querySelectorAll('.attackable').forEach(el => {
                el.classList.remove('attackable');
            });
        }

        // Aggiorna display delle unit√† con stile migliorato
        function updateUnitDisplay() {
            const unitCountsGroup = document.getElementById('unit-counts');
            unitCountsGroup.innerHTML = '';

            Object.entries(gameState.territories).forEach(([territoryId, territory]) => {
                const territoryElement = document.getElementById(territoryId);
                if (territoryElement) {
                    // Crea sfondo per il numero
                    const background = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    background.setAttribute('cx', territoryElement.getAttribute('cx'));
                    background.setAttribute('cy', territoryElement.getAttribute('cy'));
                    background.setAttribute('r', '12');

                    if (territory.owner === gameState.currentPlayer) {
                        background.setAttribute('fill', '#ffeb3b');
                        background.setAttribute('stroke', '#f57f17');
                    } else if (territory.owner === -1) {
                        background.setAttribute('fill', '#fff');
                        background.setAttribute('stroke', '#666');
                    } else {
                        background.setAttribute('fill', gameState.players[territory.owner].color);
                        background.setAttribute('stroke', '#333');
                    }
                    background.setAttribute('stroke-width', '2');
                    unitCountsGroup.appendChild(background);

                    // Crea testo numero unit√†
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('class', 'unit-count');
                    text.setAttribute('x', territoryElement.getAttribute('cx'));
                    text.setAttribute('y', parseInt(territoryElement.getAttribute('cy')) + 5);
                    text.textContent = territory.units;
                    text.setAttribute('fill', '#333');
                    text.setAttribute('stroke', 'none');
                    text.setAttribute('font-size', '14');
                    text.setAttribute('font-weight', 'bold');
                    unitCountsGroup.appendChild(text);
                }
            });
        }

        // Migliora l'effetto di disegno delle connessioni
        function drawConnections() {
            const connectionsGroup = document.getElementById('connections');
            connectionsGroup.innerHTML = '';

            Object.entries(adjacencies).forEach(([territoryId, connections]) => {
                const territory1 = document.getElementById(territoryId);
                if (!territory1) return;

                connections.forEach(connectedId => {
                    const territory2 = document.getElementById(connectedId);
                    if (!territory2) return;

                    // Evita linee duplicate
                    if (territoryId < connectedId) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', territory1.getAttribute('cx'));
                        line.setAttribute('y1', territory1.getAttribute('cy'));
                        line.setAttribute('x2', territory2.getAttribute('cx'));
                        line.setAttribute('y2', territory2.getAttribute('cy'));
                        line.setAttribute('stroke', '#8d6e63');
                        line.setAttribute('stroke-width', '2');
                        line.setAttribute('stroke-dasharray', '5,5');
                        line.setAttribute('opacity', '0.6');
                        connectionsGroup.appendChild(line);
                    }
                });
            });
        }

        // Aggiorna la funzione updateDisplay per usare la nuova visualizzazione
        function updateDisplay() {
            const currentPlayer = gameState.players[gameState.currentPlayer];

            // Info giocatore corrente
            document.getElementById('player-name').textContent = currentPlayer.name;
            document.getElementById('player-emoji').textContent = currentPlayer.emoji;
            document.getElementById('player-color').style.background = currentPlayer.color;
            document.getElementById('turn-counter').textContent = gameState.turn;

            // Fase corrente
            const phaseNames = {
                'reinforcement': 'Rinforzi',
                'attack': 'Attacco',
                'move': 'Movimento'
            };
            document.getElementById('current-phase').textContent = phaseNames[gameState.phase];

            // Info fazione dettagliate
            document.getElementById('faction-name').textContent = `${currentPlayer.emoji} Clan dei ${currentPlayer.name}`;
            document.getElementById('leader-name').textContent = currentPlayer.leader;
            document.getElementById('ability-name').textContent = currentPlayer.ability;
            document.getElementById('ability-desc').textContent = currentPlayer.abilityDescription;
            document.getElementById('faction-bonus').textContent = currentPlayer.bonus;
            document.getElementById('faction-weakness').textContent = currentPlayer.weakness;

            document.getElementById('territory-count').textContent = currentPlayer.territories.length;
            document.getElementById('reinforcements').textContent = gameState.reinforcements;
            document.getElementById('battle-count').textContent = gameState.battleCount;

            // Bottone abilit√† leader
            const abilityBtn = document.getElementById('leader-ability');
            abilityBtn.disabled = currentPlayer.abilityUsed || gameState.phase === 'reinforcement';
            abilityBtn.textContent = currentPlayer.abilityUsed ? '‚úÖ Abilit√† Usata' : 'üåü Usa Abilit√† Leader';

            // Aggiorna colore bordo info fazione
            const factionInfo = document.getElementById('faction-info');
            factionInfo.style.borderLeftColor = currentPlayer.color;

            // Aggiorna visualizzazione unit√†
            updateUnitDisplay();

            // Aggiorna stato bottoni
            document.getElementById('place-reinforcements').disabled =
                gameState.reinforcements === 0 || gameState.phase !== 'reinforcement';
            document.getElementById('next-phase').disabled =
                (gameState.phase === 'reinforcement' && gameState.reinforcements > 0);

            // Aggiorna carte evento
            updateEventCardsDisplay();

            // Abilita fase movimento se necessario
            if (gameState.phase === 'move') {
                enableMovementPhase();
            }
        }

        // Battaglia migliorata
        function performBattle(fromId, toId) {
            const attacker = gameState.territories[fromId];
            const defender = gameState.territories[toId];
            const attackerPlayer = gameState.players[gameState.currentPlayer];
            const defenderPlayer = defender.owner === -1 ? null : gameState.players[defender.owner];

            gameState.battleCount++;

            // Calcola modificatori
            let attackBonus = 0;
            let defenseBonus = 0;

            // Bonus fazioni
            const relations = factionRelations[gameState.currentPlayer];
            if (defenderPlayer && relations.weakness && relations.weakness.includes(defender.owner)) {
                attackBonus -= 1;
                addLogEntry(`‚ö†Ô∏è ${attackerPlayer.name} subisce malus vs ${defenderPlayer.name}`, 'log-attack');
            }

            if (gameState.currentPlayer === 1 && defenderPlayer && !factionRelations[defender.owner]?.bulb) {
                attackBonus += 1;
                addLogEntry(`üßÖ Bonus Cipolle: +1 attacco vs non-bulbo`, 'log-attack');
            }

            if (gameState.currentPlayer === 4 && attacker.units >= 5) {
                attackBonus += 1;
                addLogEntry(`üçÖ Bonus Pomodori: +1 attacco per grande esercito`, 'log-attack');
            }

            // Bonus territori
            const defenderTerritoryType = territoryTypes[toId];
            if (defenderTerritoryType && defenderPlayer) {
                if (defender.owner === 0 && defenderTerritoryType.type === 'mountain') {
                    defenseBonus += 1;
                    addLogEntry(`‚ùÑÔ∏è Bonus Cavolfiori: +1 difesa in montagna`, 'log-defend');
                }

                if (gameState.currentPlayer === 4 &&
                    (defenderTerritoryType.type === 'dry' || defenderTerritoryType.type === 'mountain')) {
                    attackBonus -= 1;
                    addLogEntry(`üçÖ Malus Pomodori: territorio sfavorevole`, 'log-attack');
                }
            }

            // Lancia i dadi
            let attackerDice = Math.floor(Math.random() * 6) + 1 + attackBonus;
            let defenderDice = Math.floor(Math.random() * 6) + 1 + defenseBonus;

            // Abilit√† Lacrime Corrosive
            if (gameState.currentPlayer === 1 && attackerPlayer.abilityUsed) {
                defenderDice = Math.max(1, defenderDice - 1);
                addLogEntry(`üíß Lacrime Corrosive: dado nemico ridotto!`, 'log-attack');
            }

            // Mostra i dadi
            showDiceRoll(attackerDice, defenderDice);

            const fromName = territoryTypes[fromId].name;
            const toName = territoryTypes[toId].name;

            addLogEntry(`‚öîÔ∏è ${fromName} (${attackerDice}) attacca ${toName} (${defenderDice})`, 'log-attack');

            if (attackerDice > defenderDice) {
                // Attaccante vince
                defender.units--;
                addLogEntry(`üí• ${toName} perde 1 unit√†!`, 'log-attack');

                // Abilit√† Polpa Esplosiva
                if (gameState.currentPlayer === 4 && attackerPlayer.abilityUsed) {
                    adjacencies[toId].forEach(adjId => {
                        const adjTerritory = gameState.territories[adjId];
                        if (adjTerritory && adjTerritory.owner !== gameState.currentPlayer &&
                            adjTerritory.owner !== -1 && adjTerritory.units > 1) {
                            adjTerritory.units--;
                            addLogEntry(`üí• Polpa Esplosiva colpisce ${territoryTypes[adjId].name}!`, 'log-attack');
                        }
                    });
                }

                if (defender.units <= 0) {
                    // Territorio conquistato
                    const oldOwner = defender.owner;
                    defender.owner = gameState.currentPlayer;
                    defender.units = Math.max(1, attacker.units - 1);
                    attacker.units = 1;

                    // Aggiorna liste territori
                    if (oldOwner !== -1) {
                        gameState.players[oldOwner].territories =
                            gameState.players[oldOwner].territories.filter(t => t !== toId);
                    }
                    attackerPlayer.territories.push(toId);

                    addLogEntry(`üèÜ ${toName} conquistato dai ${attackerPlayer.name}!`, 'log-attack');

                    // Cambia colore territorio
                    document.getElementById(toId).className = `territory ${getFactionClass(gameState.currentPlayer)}`;

                    // Controlla vittoria
                    checkVictory();
                }
            } else {
                // Difensore vince
                attacker.units--;
                addLogEntry(`üõ°Ô∏è ${fromName} perde 1 unit√† nell'attacco fallito!`, 'log-defend');
            }

            deselectTerritory();
            updateDisplay();
        }

        function showDiceRoll(attackerDice, defenderDice) {
            // Rimuovi dadi precedenti
            document.querySelectorAll('.dice').forEach(dice => dice.remove());

            // Crea contenitore dadi
            const logContent = document.getElementById('log-content');
            const diceContainer = document.createElement('div');
            diceContainer.className = 'dice-container';

            const attackerDiceEl = document.createElement('div');
            attackerDiceEl.className = 'dice attacker';
            attackerDiceEl.textContent = attackerDice;

            const defenderDiceEl = document.createElement('div');
            defenderDiceEl.className = 'dice defender';
            defenderDiceEl.textContent = defenderDice;

            diceContainer.appendChild(attackerDiceEl);
            diceContainer.appendChild(document.createTextNode(' VS '));
            diceContainer.appendChild(defenderDiceEl);

            logContent.appendChild(diceContainer);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function getFactionClass(playerIndex) {
            const classes = ['cavolfiori', 'cipolle', 'carote', 'broccoli', 'pomodori'];
            return classes[playerIndex] || 'neutrale';
        }

        // Piazza rinforzi automaticamente
        function placeReinforcements() {
            const playerTerritories = gameState.players[gameState.currentPlayer].territories
                .filter(tId => gameState.territories[tId]);

            while (gameState.reinforcements > 0 && playerTerritories.length > 0) {
                const borderTerritories = playerTerritories.filter(tId => {
                    return adjacencies[tId].some(adjId => {
                        const adjTerritory = gameState.territories[adjId];
                        return adjTerritory && adjTerritory.owner !== gameState.currentPlayer;
                    });
                });

                const targetTerritories = borderTerritories.length > 0 ? borderTerritories : playerTerritories;
                const randomTerritory = targetTerritories[Math.floor(Math.random() * targetTerritories.length)];

                gameState.territories[randomTerritory].units++;
                gameState.reinforcements--;
            }

            addLogEntry(`üéØ Rinforzi piazzati strategicamente sui territori di confine`, 'log-move');
            updateDisplay();
        }

        // Gestione fasi
        function nextPhase() {
            if (gameState.phase === 'reinforcement') {
                gameState.phase = 'attack';
                document.getElementById('attack-btn').disabled = false;
                addLogEntry(`‚öîÔ∏è Fase attacco iniziata per i ${gameState.players[gameState.currentPlayer].name}`, 'log-move');
            } else if (gameState.phase === 'attack') {
                gameState.phase = 'move';
                document.getElementById('end-turn').disabled = false;
                addLogEntry(`üö∂ Fase movimento iniziata`, 'log-move');
            }

            deselectTerritory();
            updateDisplay();
        }

        function toggleAttackMode() {
            gameState.attackMode = !gameState.attackMode;
            const btn = document.getElementById('attack-btn');
            btn.textContent = gameState.attackMode ? 'üî• Attacco Attivo!' : '‚öîÔ∏è Modalit√† Attacco';
            btn.style.background = gameState.attackMode ?
                'linear-gradient(45deg, #ff5722, #d84315)' :
                'linear-gradient(45deg, #f44336, #d32f2f)';
        }

        // Fine turno
        function endTurn() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % gameState.players.length;
            gameState.phase = 'reinforcement';
            gameState.turn++;

            // Reset abilit√†
            gameState.players[gameState.currentPlayer].abilityUsed = false;

            // Calcola nuovi rinforzi
            gameState.reinforcements = calculateReinforcements(gameState.currentPlayer);

            // Abilit√† passive fine turno
            if (gameState.currentPlayer === 3) { // Broccoli - Crescita Rapida
                const player = gameState.players[3];
                player.territories.forEach(tId => {
                    const territory = gameState.territories[tId];
                    if (territory && territory.units === 1) {
                        territory.units++;
                        addLogEntry(`üå± Crescita Rapida: +1 unit√† in ${territoryTypes[tId].name}`, 'log-special');
                    }
                });
            }

            deselectTerritory();

            // Reset bottoni
            document.getElementById('attack-btn').disabled = true;
            document.getElementById('end-turn').disabled = true;
            document.getElementById('attack-btn').textContent = '‚öîÔ∏è Modalit√† Attacco';
            document.getElementById('attack-btn').style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';

            const currentPlayer = gameState.players[gameState.currentPlayer];
            addLogEntry(`üîÑ Turno ${gameState.turn}: ${currentPlayer.emoji} ${currentPlayer.name} inizia!`, 'log-move');
            updateDisplay();
        }

        // Sistema carte evento
        function drawEventCard() {
            const availableCards = gameState.eventCards.filter(card =>
                !gameState.players[gameState.currentPlayer].cards.includes(card.name)
            );

            if (availableCards.length === 0) {
                addLogEntry('üé¥ Nessuna carta disponibile!', 'log-move');
                return;
            }

            const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
            gameState.players[gameState.currentPlayer].cards.push(randomCard.name);

            addLogEntry(`üé¥ Carta pescata: ${randomCard.name} - ${randomCard.description}`, 'log-special');
            updateEventCardsDisplay();
        }

        function playEventCard(cardName) {
            const card = gameState.eventCards.find(c => c.name === cardName);
            if (!card) return;

            switch (card.effect) {
                case 'boost':
                    gameState.reinforcements += card.power;
                    addLogEntry(`üåü ${card.name}: +${card.power} rinforzi!`, 'log-special');
                    break;
                case 'grow_all':
                    gameState.players[gameState.currentPlayer].territories.forEach(tId => {
                        gameState.territories[tId].units += card.power;
                    });
                    addLogEntry(`üåø ${card.name}: +${card.power} unit√† ovunque!`, 'log-special');
                    break;
                case 'destroy':
                    // Implementazione semplificata - colpisce territorio nemico casuale
                    const enemyTerritories = [];
                    Object.entries(gameState.territories).forEach(([tId, territory]) => {
                        if (territory.owner !== gameState.currentPlayer && territory.owner !== -1) {
                            enemyTerritories.push(tId);
                        }
                    });
                    if (enemyTerritories.length > 0) {
                        const target = enemyTerritories[Math.floor(Math.random() * enemyTerritories.length)];
                        gameState.territories[target].units = Math.max(1, gameState.territories[target].units - card.power);
                        addLogEntry(`üí• ${card.name}: ${territoryTypes[target].name} devastato!`, 'log-special');
                    }
                    break;
            }

            // Rimuovi carta usata
            const playerCards = gameState.players[gameState.currentPlayer].cards;
            const cardIndex = playerCards.indexOf(cardName);
            if (cardIndex > -1) {
                playerCards.splice(cardIndex, 1);
            }

            updateEventCardsDisplay();
            updateDisplay();
        }

        function updateEventCardsDisplay() {
            const cardsContainer = document.getElementById('event-cards');
            const playerCards = gameState.players[gameState.currentPlayer].cards;

            cardsContainer.innerHTML = '';

            // Bottone pesca carta
            const drawButton = document.createElement('div');
            drawButton.className = 'event-card';
            drawButton.textContent = 'üé≤ Pesca Carta Evento';
            drawButton.onclick = drawEventCard;
            cardsContainer.appendChild(drawButton);

            // Carte in mano
            playerCards.forEach(cardName => {
                const card = gameState.eventCards.find(c => c.name === cardName);
                if (card) {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'event-card';
                    cardElement.innerHTML = `<strong>${card.name}</strong><br><small>${card.description}</small>`;
                    cardElement.onclick = () => playEventCard(cardName);
                    cardsContainer.appendChild(cardElement);
                }
            });
        }

        // Controllo vittoria
        function checkVictory() {
            const alivePlayers = gameState.players.filter(player => player.territories.length > 0);

            if (alivePlayers.length === 1) {
                showVictory(alivePlayers[0]);
                return;
            }

            // Controllo dominazione territorio
            const currentPlayer = gameState.players[gameState.currentPlayer];
            if (currentPlayer.territories.length >= 12) {
                showVictory(currentPlayer);
                return;
            }

            // Controllo regioni complete
            const regionCount = calculateCompleteRegions(gameState.currentPlayer);
            if (regionCount >= 2) {
                showVictory(currentPlayer);
                return;
            }
        }

        function calculateCompleteRegions(playerIndex) {
            const player = gameState.players[playerIndex];
            const regions = {};

            player.territories.forEach(tId => {
                const territory = territoryTypes[tId];
                if (territory && territory.region) {
                    if (!regions[territory.region]) regions[territory.region] = 0;
                    regions[territory.region]++;
                }
            });

            let completeRegions = 0;
            if (regions.cipollandia === 3) completeRegions++;
            if (regions.carotegna === 3) completeRegions++;
            if (regions.tomatosia === 3) completeRegions++;
            if (regions.broccolandia === 3) completeRegions++;
            if (regions.cavolfiori === 3) completeRegions++;
            if (regions.mercato === 4) completeRegions++;

            return completeRegions;
        }

        function showVictory(winner) {
            document.getElementById('victory-title').textContent = `üèÜ VITTORIA ${winner.emoji}üèÜ`;
            document.getElementById('victory-message').textContent =
                `I ${winner.name} hanno conquistato l'orto! ${winner.leader} regna supremo!`;
            document.getElementById('victory-screen').style.display = 'flex';
        }

        function resetGame() {
            location.reload();
        }

        // Aggiorna display
        function updateDisplay() {
            const currentPlayer = gameState.players[gameState.currentPlayer];

            // Info giocatore corrente
            document.getElementById('player-name').textContent = currentPlayer.name;
            document.getElementById('player-emoji').textContent = currentPlayer.emoji;
            document.getElementById('player-color').style.background = currentPlayer.color;
            document.getElementById('turn-counter').textContent = gameState.turn;

            // Fase corrente
            const phaseNames = {
                'reinforcement': 'Rinforzi',
                'attack': 'Attacco',
                'move': 'Movimento'
            };
            document.getElementById('current-phase').textContent = phaseNames[gameState.phase];

            // Info fazione dettagliate
            document.getElementById('faction-name').textContent = `${currentPlayer.emoji} Clan dei ${currentPlayer.name}`;
            document.getElementById('leader-name').textContent = currentPlayer.leader;
            document.getElementById('ability-name').textContent = currentPlayer.ability;
            document.getElementById('ability-desc').textContent = currentPlayer.abilityDescription;
            document.getElementById('faction-bonus').textContent = currentPlayer.bonus;
            document.getElementById('faction-weakness').textContent = currentPlayer.weakness;

            document.getElementById('territory-count').textContent = currentPlayer.territories.length;
            document.getElementById('reinforcements').textContent = gameState.reinforcements;
            document.getElementById('battle-count').textContent = gameState.battleCount;

            // Bottone abilit√† leader
            const abilityBtn = document.getElementById('leader-ability');
            abilityBtn.disabled = currentPlayer.abilityUsed || gameState.phase !== 'attack';
            abilityBtn.textContent = currentPlayer.abilityUsed ? '‚úÖ Abilit√† Usata' : 'üåü Usa Abilit√† Leader';

            // Aggiorna colore bordo info fazione
            const factionInfo = document.getElementById('faction-info');
            factionInfo.style.borderLeftColor = currentPlayer.color;

            // Aggiorna unit√† sui territori
            const unitCountsGroup = document.getElementById('unit-counts');
            unitCountsGroup.innerHTML = '';

            Object.entries(gameState.territories).forEach(([territoryId, territory]) => {
                const territoryElement = document.getElementById(territoryId);
                if (territoryElement) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('class', 'unit-count');
                    text.setAttribute('x', territoryElement.getAttribute('cx'));
                    text.setAttribute('y', parseInt(territoryElement.getAttribute('cy')) + 6);
                    text.textContent = territory.units;

                    // Colore testo basato sul proprietario
                    if (territory.owner === gameState.currentPlayer) {
                        text.setAttribute('fill', '#ffff00');
                        text.setAttribute('stroke', '#333');
                    } else if (territory.owner === -1) {
                        text.setAttribute('fill', '#333');
                        text.setAttribute('stroke', '#fff');
                    } else {
                        text.setAttribute('fill', '#ffffff');
                        text.setAttribute('stroke', '#333');
                    }

                    unitCountsGroup.appendChild(text);
                }
            });

            // Aggiorna stato bottoni
            document.getElementById('place-reinforcements').disabled =
                gameState.reinforcements === 0 || gameState.phase !== 'reinforcement';
            document.getElementById('next-phase').disabled =
                (gameState.phase === 'reinforcement' && gameState.reinforcements > 0);

            // Aggiorna carte evento
            updateEventCardsDisplay();
        }

        function addLogEntry(message, className = '') {
            const logContent = document.getElementById('log-content');
            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;
            entry.textContent = message;
            logContent.appendChild(entry);

            // Mantieni solo ultimi 15 messaggi
            while (logContent.children.length > 15) {
                logContent.removeChild(logContent.firstChild);
            }

            logContent.scrollTop = logContent.scrollHeight;
        }

        // Funzioni di movimento (fase 3)
        function enableMovementPhase() {
            if (gameState.phase !== 'move') return;

            addLogEntry('üö∂ Clicca un territorio per spostare unit√† (opzionale)', 'log-move');

            // Auto-consolidamento suggerito
            setTimeout(() => {
                autoConsolidateDefenses();
            }, 1000);
        }

        function autoConsolidateDefenses() {
            const player = gameState.players[gameState.currentPlayer];
            let movementsMade = 0;

            player.territories.forEach(fromId => {
                const fromTerritory = gameState.territories[fromId];
                if (fromTerritory.units > 3) {
                    // Cerca territori adiacenti del giocatore che hanno solo 1 unit√†
                    const weakAdjacent = adjacencies[fromId].filter(adjId => {
                        const adjTerritory = gameState.territories[adjId];
                        return adjTerritory && adjTerritory.owner === gameState.currentPlayer && adjTerritory.units === 1;
                    });

                    if (weakAdjacent.length > 0 && movementsMade < 2) {
                        const targetId = weakAdjacent[0];
                        const unitsToMove = Math.floor(fromTerritory.units / 2);

                        fromTerritory.units -= unitsToMove;
                        gameState.territories[targetId].units += unitsToMove;

                        addLogEntry(`üöö Auto-consolidamento: ${unitsToMove} unit√† da ${territoryTypes[fromId].name} a ${territoryTypes[targetId].name}`, 'log-move');
                        movementsMade++;
                    }
                }
            });

            if (movementsMade === 0) {
                addLogEntry('üõ°Ô∏è Posizioni difensive ottimali mantenute', 'log-move');
            }

            updateDisplay();
        }

        // Easter eggs e animazioni
        function addVegetableEasterEgg() {
            const messages = [
                'ü•ï Una carota sussurra: "La vittoria √® a portata di radice!"',
                'üßÖ Una cipolla piange: "Lacrime di gioia per questa battaglia!"',
                'ü•¶ Un broccolo medita: "La crescita richiede pazienza..."',
                'üçÖ Un pomodoro esplode: "Tutto rosso di passione!"',
                '‚ùÑÔ∏è Un cavolfiore trema: "Il freddo non ferma la determinazione!"'
            ];

            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            addLogEntry(randomMessage, 'log-special');
        }

        // Aggiungi easter egg casuali
        setInterval(() => {
            if (Math.random() < 0.1) { // 10% di probabilit√† ogni 5 secondi
                addVegetableEasterEgg();
            }
        }, 5000);

        // Sistema di suggerimenti per nuovi giocatori
        function showHints() {
            if (gameState.turn === 1) {
                setTimeout(() => {
                    addLogEntry('üí° Suggerimento: Rinforza i territori di confine per difenderti meglio!', 'log-move');
                }, 3000);
            }

            if (gameState.turn === 2 && gameState.currentPlayer === 0) {
                setTimeout(() => {
                    addLogEntry('üí° Suggerimento: Usa l\'abilit√† del leader per ottenere vantaggi speciali!', 'log-special');
                }, 2000);
            }

            if (gameState.battleCount === 1) {
                setTimeout(() => {
                    addLogEntry('üí° Suggerimento: Conquista il Mercato Centrale per bonus potenti!', 'log-move');
                }, 4000);
            }
        }

        // Effetti sonori testuali
        function playBattleSound(isVictory) {
            const victorySounds = ['üí• KAPOW!', 'üéÜ BOOM!', '‚ö° ZAP!', 'üåü CRASH!'];
            const defeatSounds = ['üòµ OUCH!', 'üíî ARG!', 'üò© UGH!', 'ü§ï BONK!'];

            const sound = isVictory ?
                victorySounds[Math.floor(Math.random() * victorySounds.length)] :
                defeatSounds[Math.floor(Math.random() * defeatSounds.length)];

            addLogEntry(sound, 'log-attack');
        }

        // Meccaniche avanzate per bilanciamento
        function applyEndGameBoosts() {
            if (gameState.turn >= 15) {
                // Dopo turno 15, tutti ricevono +2 rinforzi (escalation)
                gameState.reinforcements += 2;
                addLogEntry('‚ö° Escalation bellica: +2 rinforzi bonus per l\'intensificarsi della battaglia!', 'log-special');
            }

            if (gameState.turn >= 18) {
                // Turno 18: Carte evento hanno effetto doppio
                addLogEntry('üî• Battaglia finale: Gli eventi sono ora DEVASTANTI!', 'log-special');
            }
        }

        // Controllo stati di stallo
        function checkStalemate() {
            if (gameState.turn >= 20) {
                // Sudden death - chi ha pi√π territori vince
                const playerScores = gameState.players.map((player, index) => ({
                    index,
                    territories: player.territories.length,
                    name: player.name,
                    emoji: player.emoji
                })).filter(p => p.territories > 0);

                playerScores.sort((a, b) => b.territories - a.territories);

                if (playerScores[0].territories > playerScores[1]?.territories || playerScores.length === 1) {
                    const winner = gameState.players[playerScores[0].index];
                    addLogEntry('‚è∞ SUDDEN DEATH! Tempo scaduto!', 'log-special');
                    showVictory(winner);
                }
            }
        }

        // Inizializza il gioco quando la pagina √® caricata
        window.addEventListener('load', () => {
            initGame();
            showHints();

            // Aggiungi messaggio di benvenuto con descrizione della mappa
            setTimeout(() => {
                addLogEntry('üó∫Ô∏è Mappa dell\'Orto Globale caricata! Esplorate le 6 regioni:', 'log-special');
                addLogEntry('üßÖ Cipollandia, ü•ï Carotegna, üçÖ San Marzano, ü•¶ Broccolandia, ‚ùÑÔ∏è Regno Cavolfiori, üè™ Mercato Centrale', 'log-move');
            }, 2000);

            // Aggiungi controllo stallo ogni turno
            const originalEndTurn = endTurn;
            endTurn = function () {
                originalEndTurn();
                applyEndGameBoosts();
                checkStalemate();
            };
        });

        // Controlli da tastiera
        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'r':
                case 'R':
                    if (gameState.phase === 'reinforcement' && gameState.reinforcements > 0) {
                        placeReinforcements();
                    }
                    break;
                case 'n':
                case 'N':
                    if (!document.getElementById('next-phase').disabled) {
                        nextPhase();
                    }
                    break;
                case 'e':
                case 'E':
                    if (!document.getElementById('end-turn').disabled) {
                        endTurn();
                    }
                    break;
                case 'a':
                case 'A':
                    if (!document.getElementById('attack-btn').disabled) {
                        toggleAttackMode();
                    }
                    break;
                case 's':
                case 'S':
                    if (!document.getElementById('leader-ability').disabled) {
                        useLeaderAbility();
                    }
                    break;
                case 'Escape':
                    deselectTerritory();
                    break;
            }
        });

        // Informazioni sui controlli
        setTimeout(() => {
            addLogEntry('‚å®Ô∏è Controlli: R=Rinforzi, N=Prossima Fase, E=Fine Turno, A=Attacco, S=Abilit√†, ESC=Deseleziona', 'log-move');
        }, 8000);
    </script>
</body>

</html>